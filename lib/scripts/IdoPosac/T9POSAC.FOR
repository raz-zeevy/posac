

      SUBROUTINE VALMAP (IFREQ, IPRF, IYES, INTPRF, NBINT2,
     $                   IBORN2, JBORN2, VALUE, NV, NCAS, NXT, M)
C
      PARAMETER (NWORDS=10)
      PARAMETER (MAXEXMAP=30)
      PARAMETER (MAXINTRV=10)
      PARAMETER (IDLEN=10)
C
      COMMON/IO/NTAPE,NREAD,NWRITE,NSCR
      COMMON/VARINT/INTERN
      COMMON/TEST/ITESTN,ITESTX
      COMMON/CC/ISMN,ISMX,IEND
      COMMON/V1V2/V1,V2,VMEAN
      COMMON/MAPLAB/LABMAP(NWORDS,MAXEXMAP)
      INTEGER*4 LABMAP
      COMMON/PARAM/IEXDIAGRM, ITEMDGPLT, IWRTFLS
      COMMON /FF/ FORMFEED
C
      INTEGER*2 ISMN,ISMX,IEND
C
      INTEGER*2 NV,NCAS,NXT,M
      INTEGER*2 IFREQ(NCAS),IPRF(NV,NCAS),IYES(NCAS),INTPRF(INTERN),
     $         NBINT2(NXT,M),IBORN2(MAXINTRV,NXT,M),
     $         JBORN2(MAXINTRV,NXT,M)
      REAL      VALUE(IEND)
C
      CHARACTER*10 ID
      CHARACTER*1 FORMFEED
C
      INTEGER*2 NFRYES,IFRYES,IFRNO,ISCO,I,J,K,L,NB,IP,INTFRQ,IPERC,
     1          NFRNO
C
C **********************************************************************
C
      IF (IEXDIAGRM.EQ.0) THEN
          ASSIGN 120 TO ISKWRT200
          ASSIGN 110 TO ISKWRT300
          ASSIGN 140 TO ISKWRT400
      ELSE
          ASSIGN 150 TO ISKWRT200
          ASSIGN 130 TO ISKWRT300
          ASSIGN 160 TO ISKWRT400
      ENDIF
C
C DUMMY ID
C
C  READ CASES IN MEMORY. This instruction reads original frequencies 
C                        written by PRFOUT.
C
      REWIND NSCR
      DO 20 I=1,NCAS
          READ(NSCR) ID,IFREQ(I),(IPRF(J,I),J=1,NV)
C  IYES IS AN INDICATOR SHOWING IF CASE I
C  WAS CONSIDERED
          IYES(I)=1
   20 CONTINUE
C
C  NOW COMPUTING FOR EACH INTERNAL PROFILE THE
C  EXISTENCE FREQUENCY OF THE EXTERNAL PROFILE IFRYES
C
      GOTO ISKWRT200
C
 150  CONTINUE
      WRITE(NWRITE,200) FORMFEED, M, (LABMAP(J,M),J=1,NWORDS)
C
C  NFRYES IS THE NUMBER OF CASES HAVING THE EXTERNAL TRAIT
C
 120  CONTINUE
C
      NFRYES=0
      NFRNO = 0
      DO 30 I=1,IEND
          READ(NSCR) ISCO,(INTPRF(J),J=1,INTERN)
          IFRYES=0
          IFRNO=0
          IF(I.EQ.1.AND.ITESTX.EQ.0) GO TO 35
          IF(I.EQ.IEND.AND.ITESTN.EQ.0) GO TO 35
C SCANNING THE CASES
          DO 60 K=1,NCAS
C COMPARE INTERNAL PROFILE I WITH CASE K
               IF(IYES(K).EQ.0) GO TO 60
               DO 70 J=1,INTERN
                    IF(IPRF(J,K).NE.INTPRF(J)) GO TO 60
   70          CONTINUE
               IYES(K)=0
C  IS THE EXTERNAL CASE OF K COINCIDES
C  WITH THE EXTERNAL TRAIT
               DO 80 J=1,NXT
                    NB=NBINT2(J,M)
                    IP=IPRF(INTERN+J,K)
                    DO 90 L=1,NB
                         IF(IP.GE.IBORN2(L,J,M).AND.
     $                            IP.LE.JBORN2(L,J,M)) GO TO 80
   90               CONTINUE
                    IFRNO=IFRNO+IFREQ(K)
                    GO TO 60
   80          CONTINUE
               IFRYES=IFRYES+IFREQ(K)
   60     CONTINUE
   35     CONTINUE
          INTFRQ=IFRYES+IFRNO
          IF(INTFRQ.EQ.0) INTFRQ=1
          VALUE(I)=IFRYES/FLOAT(INTFRQ)
          IPERC=VALUE(I)*100.+.5
C
          GOTO ISKWRT300
C
 130      CONTINUE
          IF(I.EQ.1.AND.ITESTX.EQ.0) THEN
               WRITE(NWRITE,500) I,INTFRQ,IFRYES,IFRNO,IPERC,
     $                             (INTPRF(J),J=1,INTERN)
               GOTO 110
          ENDIF
          IF(I.EQ.IEND.AND.ITESTN.EQ.0) THEN
               WRITE(NWRITE,500) I,INTFRQ,IFRYES,IFRNO,IPERC,
     $                             (INTPRF(J),J=1,INTERN)
               GOTO 110
          ENDIF
          WRITE(NWRITE,300) I,INTFRQ,IFRYES,IFRNO,IPERC,
     $                               (INTPRF(J),J=1,INTERN)
110       CONTINUE
          NFRYES=NFRYES+IFRYES
          NFRNO =NFRNO +IFRNO
   30 CONTINUE
C     NFRNO=NCAS-NFRYES  removed for unit frequency case
C  COMPUTE VMEAN FOR RELATIVE EXTERNAL TRAIT DIAGRAM
C  BUT IT IS IPERC WHICH IS PRINTED
C     VMEAN=FLOAT(NFRYES)/NCAS
      VMEAN=FLOAT(NFRYES) / (NFRYES + NFRNO)
      IPERC=VMEAN*100.+.5
C
      GOTO ISKWRT400
C
 160  CONTINUE
      WRITE(NWRITE,400) NCAS,NFRYES,NFRNO,IPERC
C
 140  CONTINUE
C
C  V1 AND V2 ARE VALUES AROUND THE MEAN : + OR - TOLER
C  TOLER = .05 : FIVE PERCENT
C
      TOLER=.05
      V1=VMEAN-TOLER
      V2=VMEAN+TOLER
      IF(V1.LT.0.) V1=0.
      IF(V2.GT.1.) V2=1.
C
      RETURN
C
  200 FORMAT(A1,20X,26HFOR EXTERNAL TRAIT NUMBER ,I2,
     $           2X,2H: ,10A4,//,
     $           7X,8HINTERNAL,4X,18HEXTERNAL-FREQUENCY,3X,
     $           8HPRESENCE,5X,8HINTERNAL,/,1X,3H ID,3X,
     $           9HFREQUENCY,3X,8HPRESENCE,3X,7HABSENCE,3X,
     $           10HPERCENTAGE,3X,7HPROFILE,/,2X,2H--,3X,9(1H-),
     $           3X,8(1H-),3X,7(1H-),3X,10(1H-),3X,7(1H-))
  300 FORMAT(1X,I3,5X,I4,8X,I4,6X,I4,8X,I3,6X,35I2)
  400 FORMAT(/,6H TOTAL,3X,I4,8X,I4,6X,I4,8X,I3)
  500 FORMAT(1X,I3,1H*,4X,I4,8X,I4,6X,I4,8X,I3,6X,35I2)
C
      END

      SUBROUTINE MUTRET (IFREQ,VALUE,XY,N)

C  THIS SUB. COMPUTES MONOTONICITY COEFFICIENTS
C  BETWEEN EXTERNAL TRAIT (YES OR NO) AND EACH
C  OF THE FOLLOWING VARIABLE
C    X    BASE COORDINATE ON X-AXIS
C    Y    BASE COORDINATE ON Y-AXIS
C    J    JOINT COORDINATE ( X+Y )
C    L    LATERAL COORDINATE ( X-Y )

      COMMON/IO/NTAPE,NREAD,NWRITE,NSCR
      COMMON/TEST/ITESTN,ITESTX
      COMMON/ZEROES/ZERO,ZEROMU2
      COMMON/PARAM/IEXDIAGRM, ITEMDGPLT, IWRTFLS
      COMMON /FF/ FORMFEED
      COMMON/NPG/NEWPAGE, PATHLEN
C
      INTEGER*2 NEWPAGE, PATHLEN
C
      INTEGER*2 N, IFREQ(N)
      REAL      VALUE(N),XY(N,2)
      CHARACTER*1 FORMFEED
      CHARACTER*6 CX,CY,CXPY,CXMY,CDOT
C
      INTEGER*2 IFIRST, NEND, NEND1, I, J, J1
C **********************************************************************
C
      CDOT = '  .   '
      UX=0.
      VX=0.
      UY=0.
      VY=0.
      UXPY=0.
      VXPY=0.
      UXMY=0.
      VXMY=0.
      IFIRST=1
      NEND=N
      IF(ITESTX.EQ.0) IFIRST=2
      IF(ITESTN.EQ.0) NEND=N-1
      NEND1=NEND-1
      DO 10 I=IFIRST,NEND1
          FI=IFREQ(I)
          FYESI=VALUE(I)*FI
          FNOI=FI-FYESI
          XI=XY(I,1)
          YI=XY(I,2)
          XPYI=XI+YI
          XMYI=XI-YI
          J1=I+1
          DO 20 J=J1,NEND
               FJ=IFREQ(J)
               FYESJ=VALUE(J)*FJ
               FNOJ=FJ-FYESJ
               FIJ1=FYESI*FNOJ
               FIJ2=FNOI*FYESJ
               CN=FIJ1-FIJ2
               CD=FIJ1+FIJ2
               XJ=XY(J,1)
               YJ=XY(J,2)
               XPYJ=XJ+YJ
               XMYJ=XJ-YJ
               XIJ=XI-XJ
               YIJ=YI-YJ
               XPYIJ=XPYI-XPYJ
               XMYIJ=XMYI-XMYJ
               UX=UX+CN*XIJ
               VX=VX+CD*ABS(XIJ)
               UY=UY+CN*YIJ
               VY=VY+CD*ABS(YIJ)
               UXPY=UXPY+CN*XPYIJ
               VXPY=VXPY+CD*ABS(XPYIJ)
               UXMY=UXMY+CN*XMYIJ
               VXMY=VXMY+CD*ABS(XMYIJ)
   20     CONTINUE
   10 CONTINUE
C
      IF (VX.GT.ZEROMU2) THEN
          WRITE (CX,103) UX/VX
      ELSE
          CX = CDOT
      END IF
C
      IF (VY.GT.ZEROMU2) THEN
          WRITE (CY,103) UY/VY
      ELSE
          CY = CDOT
      END IF
C
      IF (VXPY.GT.ZEROMU2) THEN
          WRITE (CXPY,103) UXPY/VXPY
      ELSE
          CXPY = CDOT
      END IF
C
      IF (VXMY.GT.ZEROMU2) THEN
          WRITE (CXMY,103) UXMY/VXMY
      ELSE
          CXMY = CDOT
      END IF
C
      IF (NEWPAGE.EQ.1) WRITE (NWRITE,101) FORMFEED
      WRITE(NWRITE,100) CX,CXPY,CY,CXMY
C
C         NOTE: unit IWRTFLS is opened and closed in PLOTS
C                    as MUTRET is called in a loop.
C
      IF (IWRTFLS .GT. 0) WRITE (IWRTFLS, 102) CX,CXPY,CY,CXMY
C
      NEWPAGE = 0
C
      RETURN
C
  100 FORMAT(//,13H MU(TRAIT,X)=,A6,20X,12HMU(TRAIT,J)=,A6/
     $          13H MU(TRAIT,Y)=,A6,20X,12HMU(TRAIT,L)=,A6//
     $       '  * A DOT (.) IS PRINTED IF THE COEFFICIENT ',
     $       'CANNOT BE COMPUTED.')
  101 FORMAT(A1)
  102 FORMAT (4(1X,A6))
  103 FORMAT (F6.3)
C
      END

      SUBROUTINE EXTWRT (SOL, VALUE, IFREQ, N, IEXTOUT)

C  THIS SUB. WRITES THE EXTERNAL TRAIT INFORMATION
C  FOR THE INPUT "VALUE" AND  FOR THE SOLUTION
C  "SOL" ON UNIT IEXTOUT. VALUE(I) IS THE PROPORTION OF
C  FOUNDED EXTERNAL TRAIT FOR INTERNAL PROFILE I
C  THE FREQUENCY OF EACH PROFILE IS ALSO WRITTEN.
C
      COMMON/V1V2/V1,V2,VMEAN
      INTEGER*2 N, IFREQ(N)
      REAL      SOL(N,2), VALUE(N)
C
      WRITE (IEXTOUT) V1, V2, VMEAN, N
      DO 20 KJ=1,N
          WRITE (IEXTOUT) SOL (KJ,1), SOL (KJ,2), VALUE (KJ),
     1                    IFREQ (KJ)
  20  CONTINUE
      RETURN
      END

      SUBROUTINE PLTMAP(SOL,IXY,VALUE,IFREQ,N,IRELT)

C  THIS SUB. PLOTS THE EXTERNAL TRAIT DIAGRAM
C  FOR THE INPUT "VALUE" AND  FOR THE SOLUTION
C  "SOL" . VALUE(I) IS THE PROPORTION OF
C  FOUNDED EXTERNAL TRAIT FOR INTERNAL PROFILE I
C  THE FREQUENCY OF EACH PROFILE IS ALSO PLOTTED
C  IXY IS A WORKING AREA
C  THE INPUT COORDINATES SOL(.,1) (FIRST AXIS)
C  AND SOL(.,J) (SECOND AXIS) HAVE TO LIE
C  BETWEEN 0. AND 100.
C
C  IF IRELT=0   ABSOLUTE MAP IS PLOTTED
C  IF IRELT.NE.0 RELATIVE MAP IS PLOTTED

      INTEGER*2 N, IRELT, IXY(N,2),IFREQ(N)
      REAL      SOL(N,2),VALUE(N)
C
      INTEGER*2 IW(102), IBLANK, LOO,LAA,LBB,LCC, LDD,LEE,LII, LLL,LHH
C
      COMMON/IO/NTAPE,NREAD,NWRITE,NSCR
      COMMON/V1V2/V1,V2,VMEAN
      COMMON/BOXSTRNG/UP,BOTTM,LEFT,RIGHT,
     $               UPLEFT,UPRIGHT,BOTTMLEFT,BOTTMRIGHT
      COMMON /WCHAR/ FOR, DUMMY
C
      CHARACTER*4 FOR(107), DUMMY
      CHARACTER*1 UP,BOTTM,LEFT,RIGHT,
     $             UPLEFT,UPRIGHT,BOTTMLEFT,BOTTMRIGHT
      CHARACTER*4 F1,F107,SK8,FALF,FINT
      CHARACTER*5 I100,I50,I0,IBL
C
      INTEGER*2 NCOOR,NPOSY,NPOSX,NFOR,K,LL,KY,JJ,KJ,KF
C
      DATA F1,F107 /4H(3X,    ,4H)         /
      DATA SK8/  4HA5         /
      DATA FALF,FINT/  4H,A1         ,4H,I1         /
      DATA I100,I50,I0,IBL/5H100.. ,5H 50..  ,5H  0..  ,5H       /
C
      DATA IBLANK/2H         /
      DATA LOO,LAA,LBB,LCC/2HO       ,2HA       ,2HB      ,2HC      /
      DATA LDD,LEE,LII/2HD        ,2HE       ,2HI         /
      DATA LLL,LHH/2HL       ,2HH       /
C
C  THIS PLOT IS AVAILABLE FOR 51
C  POSITIONS IN EACH AXIS SINCE THE
C  COORDINATES GO FROM 0./2 TO 100./2
C
      NCOOR=50
      NPOSY=NCOOR+1
      NPOSX=2*NPOSY
      NFOR=3+NPOSX+2
C
C  INITIALIZE FORMAT ARRAY
C      DO 1 K=1,NFOR
C          FOR(K)=BLANK
C    1 CONTINUE
      FOR(1)=F1
      FOR(2)=SK8
      FOR(3)=FALF
      FOR(NFOR-1)=FALF
      FOR(NFOR)=F107
C
C  POINT COORDINATES ON FIRST AXIS
      DO 3 K=1,N
           IXY(K,1)=.5*SOL(K,1)+1.5
    3 CONTINUE
C
C  POINT COORDINATES ON SECOND AXIS
      DO 71 K=1,N
          LL=.5*SOL(K,2)+1.5
          IXY(K,2)=NPOSY+1-LL
   71 CONTINUE
      WRITE(NWRITE,72)
      WRITE(NWRITE,1001) UPLEFT,(UP,JJ=1,102),UPRIGHT
      DO 18 KY=1,NPOSY
          DO 7 K=1,NPOSX
               IW(K)=IBLANK
               FOR(K+3)=FALF
    7     CONTINUE
          DO 9 KJ=1,N
               IF(IXY(KJ,2).NE.KY) GO TO 9
               K=IXY(KJ,1)
               VKJ=VALUE(KJ)
               KF=2*K-1
               IF(IRELT.NE.0) GO TO 100
               IF(VKJ.LE.0.) IW(KF)=LOO
               IF(VKJ.GT.0..AND.VKJ.LE..2) IW(KF)=LAA
               IF(VKJ.GT..2.AND.VKJ.LE..4) IW(KF)=LBB
               IF(VKJ.GT..4.AND.VKJ.LT..6) IW(KF)=LCC
               IF(VKJ.GE..6.AND.VKJ.LT..8) IW(KF)=LDD
               IF(VKJ.GE..8.AND.VKJ.LT.1.) IW(KF)=LEE
               IF(VKJ.GE.1.) IW(KF)=LII
               GO TO 200
  100          CONTINUE
               IF(VKJ.LE.V1) IW(KF)=LLL
               IF(VKJ.GT.V1.AND.VKJ.LT.V2) IW(KF)=LAA
               IF(VKJ.GE.V2) IW(KF)=LHH
  200          CONTINUE
               FOR(3+1+KF)=FINT
               IW(1+KF)=IFREQ(KJ)
    9     CONTINUE
C
          IF(KY.EQ.1) THEN
               WRITE(NWRITE,FOR) I100,LEFT,IW,RIGHT
          ELSE IF(KY.EQ.(NPOSY+1)/2) THEN
               WRITE(NWRITE,FOR) I50,LEFT,IW,RIGHT
          ELSE IF(KY.EQ.NPOSY) THEN
               WRITE(NWRITE,FOR) I0,LEFT,IW,RIGHT
          ELSE
               WRITE(NWRITE,FOR) IBL,LEFT,IW,RIGHT
          ENDIF
C
   18 CONTINUE
      WRITE(NWRITE,1001) BOTTMLEFT,(BOTTM,JJ=1,102),BOTTMRIGHT
      WRITE(NWRITE,1222)
C
      RETURN
C
   72 FORMAT(/)
C
C  THE FOLLOWING FORMATS ARE
C  AVAILABLE FOR 51 POSITIONS
C
 1001 FORMAT(8X,104A1)
 1222 FORMAT(2(10X,1H.,49X,1H.,49X,1H.,/),
     $10X,1H0,48X,2H50,48X,3H100)
C
      END

      SUBROUTINE WRT (IFREQ, IPRF, ISCO, XY, IPERM, NV, NP)

C  WRITES RESULTS ON UNIT NSCR FOR
C  PROGRAMS LSA1 AND LSA2
C   AND ON UNIT INDIC FOR PRG. SHEMOR

INCLUDE 'MPARMLIN'

      COMMON/IO/NTAPE,NREAD,NWRITE,NSCR
      COMMON/SHEMOR/INDIC, IFSHMR
      COMMON/VARINT/INTERN
      COMMON/AA/IDUM1,NCAS,IDUM2,MAP,MDUM
      COMMON/FF/FORMFEED
      COMMON/LAB/LABEL (MNV),PATH
      CHARACTER*40 LABEL
      CHARACTER*80 PATH
      COMMON/BOXSTRNG/UP,BOTTM,LEFT,RIGHT,
     $               UPLEFT,UPRIGHT,BOTTMLEFT,BOTTMRIGHT
      CHARACTER*1 FORMFEED
      CHARACTER*1 UP,BOTTM,LEFT,RIGHT,
     $             UPLEFT,UPRIGHT,BOTTMLEFT,BOTTMRIGHT
C
      INTEGER*2 NV, NP, IFREQ(NP),IPRF(NV,NP),ISCO(NP),IPERM(NV)
      REAL      XY(NP,2)
      INTEGER*2 IDUM1,NCAS,IDUM2,MAP,MDUM
C
      INTEGER*2 I, J, IDUMMY
C
C **********************************************************************
C
      REWIND NSCR
      IF(MAP.EQ.0) GO TO 40
      DO 30 I=1,NCAS
         READ(NSCR)  IDUMMY
   30 CONTINUE
      DO 20 I=1,NP
         READ(NSCR) ISCO(I),(IPRF(J,I),J=1,INTERN)
   20 CONTINUE
      REWIND NSCR
   40 CONTINUE
      WRITE (NSCR) UP,BOTTM,LEFT,RIGHT,UPLEFT,UPRIGHT,
     $             BOTTMLEFT,BOTTMRIGHT,FORMFEED
      WRITE(NSCR) INT2(INTERN),NP,ISCO(1),ISCO(NP)
      WRITE(NSCR) (LABEL (IPERM(I)), I=1,INTERN)
      WRITE(INDIC) INT2(NP)
      DO 10 I=1,NP
         X=XY(I,1)
         Y=XY(I,2)
         XPRIM=X-Y+100.
         YPRIM=X+Y
         WRITE(NSCR) (IPRF(J,I),J=1,INTERN),ISCO(I),IFREQ(I),
     $                X,Y,YPRIM,XPRIM
         WRITE(INDIC)  (IPRF(J,I),J=1,INTERN),
     $                        ISCO(I), X,Y,YPRIM,XPRIM
C
   10 CONTINUE
C
      RETURN
      END

